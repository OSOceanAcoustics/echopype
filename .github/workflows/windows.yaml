name: windows-build

on:
  push:
    branches:
      - dev
      - main
    paths-ignore: [".ci_helpers/docker/**", "**/docker.yaml"]
  pull_request:
  workflow_dispatch:

env:
  CONDA_ENV: echopype

jobs:
  windows-test:
      name: windows-${{ matrix.python-version }}-build
      runs-on: "windows-latest"
      continue-on-error: ${{ matrix.experimental }}
      strategy:
        fail-fast: false
        matrix:
          include:
          - python-version: 3.9
            experimental: false
      defaults:
        run:
          shell: powershell
      steps:
        - name: Checkout repo
          uses: actions/checkout@v3
        - name: Setup Python
          uses: actions/setup-python@v4.5.0
          with:
            python-version: ${{ matrix.python-version }}
            architecture: x64
        # GitHub Action reference: https://github.com/jupyterhub/action-k3s-helm
        - name: Start a local k8s cluster
          uses: jupyterhub/action-k3s-helm@v3
          with:
            k3s-channel: latest

        - name: Verify function of k8s, kubectl, and helm
          run: |
            echo "kubeconfig: $KUBECONFIG"
            kubectl version
            kubectl get pods --all-namespaces

            helm version
            helm list
